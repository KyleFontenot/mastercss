import ProgressiveRenderingIntro from '../../rendering-modes/components/ProgressiveRenderingIntro.mdx'

<ProgressiveRenderingIntro img={{
    href: "https://nextjs.pr.beta.css.master.co",
    src: "/images/nextjs-dev.png",
    alt: 'Next.js and Master CSS',
    width: 665, height: 400, hasDark: true }} />

---

## Quick start
<StepSection>
    <Step $row>
        <StepL>
            ### <StepNum />Clone the example
            Copy-paste the following commands to quickly start using the [nextjs.pr.beta.css.master.co](https://nextjs.pr.beta.css.master.co).

            You can skip all [installation](#installation) steps.
        </StepL>
        <StepR>
            ```bash name=Terminal
            npx degit master-co/css/examples/next.js-with-progressive-rendering __my-project__
            cd __my-project__
            npm install @master/css.react@beta
            npm install
            npm run dev
            ```
        </StepR>
        <StepEnd/>
    </Step>
</StepSection>

---

## Installation

<StepSection>
    <Step $row>
        <StepL>
            ### <StepNum />Create a Next.js project
            If you don't have a Next.js project, create one first. It's recommended to refer to [Create Next App](https://nextjs.org/docs/api-reference/create-next-app).
        </StepL>
        <StepR>
            <CodeTabs>
                {[
                    {
                        name: 'Terminal',
                        lang: 'bash',
                        code: `
                            npx create-next-app@latest --experimental-app --ts
                            cd __project__
                        `
                    },
                    {
                        name: 'Terminal (pages/)',
                        lang: 'bash',
                        code: `
                            npx create-next-app@latest --ts
                            cd __project__
                        `
                    }
                ]}
            </CodeTabs>
        </StepR>
    </Step>
    <Step $row>
        <StepL>
            ### <StepNum />Install Master CSS
            Install Master CSS React into your project via package managers.
        </StepL>
        <StepR>
            ```install
            **@master/css.react@beta** **@master/css-renderer@beta** **@master/css-server@beta**
            ```
        </StepR>
    </Step>
    <Step $row>
        <StepL>
            ### <StepNum />Initialize configuration file
            Run `npx mcss init` to create a configuration file [master.css.ts](/docs/configuration).
        </StepL>
        <StepR>
            ```bash name=Terminal
            npx mcss init
            ```
        </StepR>
    </Step>
    <Step $row>
        <StepL>
            ### <StepNum />Set up CSS runtime engine
            Register Master CSS with official `CSSProvider` and provide instance context.
            1. Use `next/dynamic` to load `CSSProvider`
            2. Dynamic `js import('../master.css')`
            3. Add `css display: 'none'` in `html <html>` to avoid [FOUC](https://en.wikipedia.org/wiki/Flash_of_unstyled_content) during development

            `@master/css.react` and `master.css.js` will not be included in the page's initial JavaScript bundle.
        </StepL>
        <StepR>
            <CodeTabs>
                {[
                    {
                        name: 'app/layout.tsx',
                        lang: 'tsx',
                        code: `
                            import './globals.css'
                            +import { CSSProvider } from '@master/css.react'
                            +import config from '../master.css'

                            export const metadata = {
                                title: 'Create Next App',
                                description: 'Generated by create next app',
                            }

                            export default function RootLayout({ children }: { children: React.ReactNode }) {
                                return (
                            +        <html lang="en" style={process.env.NODE_ENV === 'development' ? { display: 'none' } : undefined}>
                                        <body>
                            +               <CSSProvider config={config}>
                                                {children}
                            +               </CSSProvider>
                                        </body>
                                    </html>
                                )
                            }
                        `
                    },
                    {
                        name: 'pages/_app.tsx',
                        lang: 'tsx',
                        code: `
                            import '../styles/globals.css'
                            import type { AppProps } from 'next/app'
                            +import dynamic from 'next/dynamic'

                            +const CSSProvider = dynamic(() => import('@master/css.react').then((m) => m.CSSProvider))

                            export default function App({ Component, pageProps }: AppProps) {
                                return (
                            +        <CSSProvider config={import('../master.css')}>
                            +            <Component {...pageProps} />
                            +        </CSSProvider>
                                )
                            }
                        `
                    }
                ]}
            </CodeTabs>
        </StepR>
    </Step>
    <Step $row>
        <StepL>
            ### <StepNum />Set up Master CSS renderer
            Statically generate CSS for each `.html` page after `next build` using the Master CSS Render CLI.

            (i) Next.js 13 has deprecated `getInitialProps`, and there is no alternative, so now only static output is supported.
        </StepL>
        <StepR>
            <CodeTabs>
                {[
                    {
                        name: 'package.json',
                        lang: 'js',
                        code: `
                            {
                                "scripts": {
                                    "dev": "next dev",
                        -            "build": "next build",
                        +            "build": "next build && mcss render \\".next/**/*.html\\"",
                                    "start": "next start",
                                    "lint": "next lint"
                                }
                            }
                        `
                    },
                    {
                        name: 'pages/_document.tsx',
                        lang: 'tsx',
                        code: `
                            import NextDocument, { Html, Head, Main, NextScript, DocumentContext } from 'next/document'
                            +import { renderCSS } from '@master/css-server'
                            +import { config } from '../master.css'

                            export default function Document() {
                                return (
                                    <Html lang="en">
                                        <Head />
                                        <body>
                                            <Main />
                                            <NextScript />
                                        </body>
                                    </Html>
                                )
                            }

                            +Document.getInitialProps = async (ctx: DocumentContext) => {
                            +    const initialProps = await NextDocument.getInitialProps(ctx)
                            +    const css = renderCSS(initialProps.html, config)
                            +    return {
                            +        ...initialProps,
                            +        styles: (
                            +            <>
                            +                <style id="master" dangerouslySetInnerHTML={{ __html: css.text }}></style>
                            +                {initialProps.styles}
                            +            </>
                            +        )
                            +    }
                            +}
                        `
                    }
                ]}
            </CodeTabs>
        </StepR>
    </Step>
    <Step $row>
        <StepL>
            ### <StepNum />Launch server
            Run `npm run dev` to start your Next.js development server
        </StepL>
        <StepR>
            ```bash name=Terminal
            npm run dev
            ```
        </StepR>
    </Step>
    <Step>
        ### <StepNum />Start using Master CSS
        Now style your first element using Master CSS syntax!
        ```tsx name=app/page.tsx
        export default function Home() {
            return (
                <h1 className="**font:40** **font:heavy** **italic** **m:50** **text:center**">Hello World</h1>
            )
        }
        ```
        <p className="mt:12x">Open your browser to watch the changes.</p>
        <HelloWorld url="localhost:3000" />
    </Step>
</StepSection>